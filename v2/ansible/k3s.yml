---
# STEP 06 â€“ Install K3s cluster (FINAL)

- name: Wait for SSH from host
  hosts: all
  gather_facts: false
  tasks:
    - name: Wait until SSH port is reachable
      wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: 600
      delegate_to: localhost

- name: Install k3s server (master)
  hosts: master
  become: true
  gather_facts: false
  tasks:
    - name: Install k3s server (non-blocking)
      shell: |
        curl -sfL https://get.k3s.io | \
        K3S_NODE_NAME={{ inventory_hostname }} \
        sh -s - server --disable traefik
      args:
        creates: /usr/local/bin/k3s
      async: 900
      poll: 0

    - name: Wait for k3s server bootstrap (node-token)
      wait_for:
        path: /var/lib/rancher/k3s/server/node-token
        timeout: 600

    - name: Read node token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token

    - name: Set k3s token fact
      set_fact:
        k3s_node_token: "{{ k3s_token.content | b64decode | trim }}"

- name: Join workers to cluster
  hosts: workers
  become: true
  gather_facts: false
  vars:
    k3s_url: "https://{{ hostvars['k3s-master'].ansible_host }}:6443"
    k3s_token: "{{ hostvars['k3s-master'].k3s_node_token }}"
  tasks:
    - name: Install k3s agent (non-blocking)
      shell: |
        curl -sfL https://get.k3s.io | \
        K3S_URL={{ k3s_url }} \
        K3S_TOKEN={{ k3s_token }} \
        K3S_NODE_NAME={{ inventory_hostname }} \
        sh -
      args:
        creates: /usr/local/bin/k3s-agent
      async: 900
      poll: 0
